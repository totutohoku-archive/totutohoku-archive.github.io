<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=x-sjis">
<META name="GENERATOR" content="IBM HomePage Builder 2001 V5.0.0 for Windows">
<TITLE>システマティック麻雀工学：応用麻雀数理学</TITLE>
</HEAD>
<BODY background="1052.gif" bgcolor="#e0e0e0" text="#000000" vlink="#400080" alink="#ff7f00" link="#ff0000">
<P>システマティック麻雀工学：<BR>
<B><FONT size="+3">戦術の構築・基礎論（1）</FONT></B><BR>
<BR>
戦術の構築・基礎論（1）・・・<BR>
最強の自動打ちツール開発に必要な「テンパイ近傍での損得計算」を理論化するための基礎理論。<BR>
「追っかけすべきか、ベタオリすべきか」などの判定において理論的に解を求めるための方法論（基礎）を定式化する。<BR>
「順目」を理論に導入する方法を検討する（〜順遅らせてでもリャンメンを作るべきかどうか、などの判断）。<BR>
<BR>
<BR>
<BR>
<B><FONT size="+1">他家と自分との和了近辺での結果評価の方法論：</FONT></B><BR>
<BR>
他家ｉがある順目ｊに降りていない他家1家からロン和了する確率がＴr（ｉ，ｊ）、ある順目jにツモ和了する確率がTt（ｉ，ｊ）で表されているとする。<BR>
また自分のそれをＪｒ（ｊ）、Ｊｔ（ｊ）と表す。現在はｒ順目であり、Ｒ順目に流局する。<BR>
自分がある牌を切る場合に、和了確率、放銃確率、流局確率はいくらになるか。<BR>
<BR>
まずｒ順目の一打がロン和了される確率については、その牌が現物であるかないかによるが、現物でない場合は<BR>
H（ｒ）=｛1-（1-Ｔｒ（1,ｒ））*（1-Ｔｒ（2,ｒ））*（1-Ｔｒ（3,ｒ））｝である。<BR>
次に他家1がツモる確率がT（１，ｒ）<BR>
他家1の牌を他家がロンする確率が｛1-（1-Ｔｒ（2,r））*（1-Ｔｒ（3,r））｝<BR>
他家1の牌を自分がロンできる確率がJｒ（ｒ）<BR>
他家2の牌を他家3がロンする確率が｛1-（1-Ｔｒ（3,r））｝<BR>
他家2の牌を自分がロンできる確率がJｒ（ｒ）<BR>
他家2の牌を他家1がロンする確率が｛1-（1-Ｔｒ（1,r））｝<BR>
他家3の牌を自分がロンできる確率がJｒ（ｒ）<BR>
他家3の牌を他家がロンする確率が｛1-（1-Ｔｒ（1,r））*（1-Ｔｒ（2,r））｝<BR>
次の自分のツモが自分のツモ和了である確率がJｔ（r）<BR>
これらは各々、前項以前の結果を条件とした条件付き確率であるから、実際には「前項の事柄が起こらない確率×その項で起こる条件付き確率＝実際にその項が起きる確率」である。<BR>
一見したところ面倒な計算に見えるが、他家がリーチしているかどうかや、降りているかどうか、2フーロしているかどうかなどによって、Tｒ（ｉ，ｊ）、Ｔｔ（ｉ，ｊ）は単純化して実測できる。<BR>
Ｊｒ（ｊ）、Ｊｔ（ｊ）についても、降りているかどうかと待ち牌の枚数などから概算できる。<BR>
したがって、順次数値計算させていくことで、これらの確率を求めることができる。<BR>
以上で、1順での自分や各々の他家の和了・放銃の分布が計算できる。<BR>
2順後、3順後・・・も繰り返す場合も同様に繰り返し計算できる（線形時間解決可能な演算、つまり1順につき「ｎ回」の計算ですむ演算である）。<BR>
<BR>
ここで重要なことは、<BR>
・「切る順番」によって和了率や放銃率が完全に一変する可能性がある<BR>
・相手がテンパイする順目や、テンパイしたかどうかによって、判断が一変する可能性がある<BR>
などの影響を計算に導入したことである。<BR>
「4人ともマンガンテンパイ」なら、普通に考えれば勝負して損ではないが、実は麻雀における選択である「自分が牌を切る」状態での有利不利の比較となると、その牌が危険であるか否かによって、有利度がかなり違ってくるわけである。<BR>
また、単に「流局までに和了できる確率を最大にする」のと、「14順目前後を目標に和了を目指す」のとでは、強さが違ってくる（後者の方が圧倒的に強い）。<BR>
ここを粗雑に扱ってしまうと、実際に強者が打ち分ける「攻め・降り」などの判断から乖離した計算結果がうまれてしまうことになる。<BR>
<BR>
<BR>
自分がテンパイ時に手変わりする可能性がある場合などに、リーチすべきか、手変わりを待つか、テンパイを崩すかという判断がある。<BR>
より単純には、リーチすべきか、ダマにすべきかという判断がある。<BR>
これらの判断において、上のような「1順計算」を基礎として、手変わりまでの順目やその場合の和了放銃の分布を計算することが大切である。<BR>
なお流局時の収支、リーチ棒の収支についても考慮すべきである。<BR>
<BR>
<BR>
途中以降で他家がリーチしてきて和了率や他家の降り率などが大きく変化する場合もあるが、重要なのは「ある1順で、自分がある行動をした時、その行動によるその後の他家の動き方の平均値がわかっていること」であり、実際にさらに他家がどう動くかで場合分けする必要はない（だから線形的な時間で計算できる）。<BR>
<BR>
<BR>
以上のようにして、ＴｒやＪｒや、リーチのあるなしによる他家の降り具合などを適当に実測から定めてやれば、「待ちの変化」の様々な組み合わせに対して、各々線形時間演算でその結果の「良さ」が計算できることとなる（ただし、途中で自分がリーチするなど、「自分の行動が他家の行動に重大な影響を与える」可能性がある場合には、その場合のパラメータ変化を追う必要があり、いくつかの場合わけは必要となる）。<BR>
このことは、「テンパイ時に何を切るべきか（リーチすべきか）」の判断が短時間で計算可能なこと、しかも全順目に渡る計算が可能であることを示している。<BR>
<BR>
実は麻雀の理論的な「最善手」を完全に計算をしようとすると、順目が増加するとともに計算量が指数関数的に増えるために「4順後」などの計算も現実的ではない。<BR>
かといって、「テンパイしたから、和了率×得点が期待値」などの適当な計算にまで単純化してしまうと、細かな「攻める、降りる」や、「テンパイを崩す」などの判断が全くできない。<BR>
上記に記した方法は、合理的であるとともに計算時間を短縮することに成功している。<BR>
<BR>
<BR>
<BR>
<B><FONT size="+1">実装例：</FONT></B><BR>
<BR>
このようなルーチンの実装に際して必要な、簡単な例を以下に示す。<BR>
ここで、降りているプレイヤーやノーテンが明らかな他家がいる場合はその放銃率や和了確率を0とするなど補正すればよい。<BR>
<BR>
<BR>
Pelse=1;<BR>
//自分の1打が他家にロンされる確率（ここだけは、その牌に応じて簡単にでも補正するべき）<BR>
take1ronbyjibun=Tr[1,r];<BR>
Pelse=Pelse*(1-take1ronbyjibun=Tr[1,r]);<BR>
take2ronbyjibun=Tr[2,r];<BR>
Pelse=Pelse*(1-take1ronbyjibun=Tr[2,r]);<BR>
take3ronbyjibun=Tr[3,r];<BR>
Pelse=Pelse*(1-take1ronbyjibun=Tr[3,r]);<BR>
//他家1がツモる確率<BR>
take1tumo=Pelse*Tt[1,r];<BR>
Pelse=Pelse*(1-Tt[r,1];)<BR>
//他家1の牌を他家2がロンする確率<BR>
take2ronbytake1=Pelse*Tr[2,r];<BR>
Pelse=Pelse*(1-Tr[2,r]);<BR>
//他家1の牌を他家3がロンする確率<BR>
take3ronbytake1=Pelse*Tr[3,r];<BR>
Pelse=Pelse*(1-Tr[3,r]);<BR>
//他家1の牌を自分がロンできる確率<BR>
jibunronbytake1=Pelse*Jr[r];<BR>
Pelse=Pelse*(1-Jr[r]);<BR>
//他家2の牌を他家3がロンする確率<BR>
take3ronbytake2=Pelse*(Tr[3,r]);<BR>
Pelse=Pelse*(1-Tr[3,j]);<BR>
//他家2の牌を自分がロンできる確率<BR>
jibunronbytake2=Pelse*Jr[r];<BR>
Pelse=Pelse*(1-Jr[r]);<BR>
//他家2の牌を他家1がロンする確率<BR>
take1ronbytake2=Pelse*(Tr[1,r]);<BR>
Pelse=Pelse*(1-(Tr[1,r]));<BR>
//他家3の牌を自分がロンできる確率<BR>
jibunronbytake3=Tr[3,j];<BR>
Pelse=Pelse*(1-Tr[3,j]);<BR>
//次の自分のツモが自分のツモ和了である確率<BR>
jibuntumo=Jt[r];<BR>
Pelse=Pelse*(1-Jt[r]);<BR>
//結果的に次の順目を迎える確率<BR>
Pelse;<BR>
<BR>
全て簡単な数値演算なので、2順目以降に適用する場合は1順目のPelseを送って2順目を呼び出す。<BR>
途中で自分のリーチなどがある確率で入って分布が変化する場合は、そのような組み合わせで場合分けする。<BR>
自分がテンパイの時は、このルーチンで全通り（1順後にツモ、2順後に形変化・・・の期待値）を計算する。<BR>
ただし、1シャンテンやリャンシャンテンなどで組み合わせ数が膨大になるときは、およその平均値で計算すればよい（例えばテンパイまでの期待順目など）。<BR>
<BR>
各々のデータについては別途収集する必要がある。<BR>
<BR>
なお、全ての局の結果は「〜〜が起きる確率」で表されるが、点数状況判断理論の結果を用いることで、「〜〜が起きた場合の順位変化」を追うことができる。<BR>
いくつかの打牌の組み合わせに対して起きる全ての順位変化の平均をとって、「最善の打牌」を選択することが最終的な目標である。<BR>
<BR>
<BR>
<BR>
<B><FONT size="+1">「誰も仕掛けていない状態」でのTrやTtの初期値：</FONT></B><BR>
<BR>
comjong.com（旧麻雀解析）の「棒テンの解析」の研究結果を利用して、各順目に他家がテンパイまたはツモ和了する確率を算出する。<BR>
10000局に対して、各順目に-1シャンテン（和了）、0シャンテン（テンパイ）になった回数が示されているので、この2つの回数を合わせたものを「その順目までにテンパイまたは和了している回数」とし、それを10000で割ってテンパイ率とした。<BR>
</P>
<TABLE border="1">
  <TBODY>
    <TR>
      <TD>順</TD>
      <TD>ﾃﾝﾊﾟｲorﾂﾓ</TD>
      <TD>ツモ(累積)</TD>
      <TD>その順目でツモ</TD>
      <TD>その順目でのロン</TD>
    </TR>
    <TR>
      <TD align="right">1</TD>
      <TD align="right">0.07</TD>
      <TD align="right">0</TD>
      <TD align="right">0</TD>
      <TD align="right">0</TD>
    </TR>
    <TR>
      <TD align="right">2</TD>
      <TD align="right">0.22</TD>
      <TD align="right">0.01</TD>
      <TD align="right">0.01</TD>
      <TD align="right">0.03</TD>
    </TR>
    <TR>
      <TD align="right">3</TD>
      <TD align="right">0.66</TD>
      <TD align="right">0.01</TD>
      <TD align="right">0</TD>
      <TD align="right">0</TD>
    </TR>
    <TR>
      <TD align="right">4</TD>
      <TD align="right">1.88</TD>
      <TD align="right">0.04</TD>
      <TD align="right">0.03</TD>
      <TD align="right">0.09</TD>
    </TR>
    <TR>
      <TD align="right">5</TD>
      <TD align="right">3.81</TD>
      <TD align="right">0.14</TD>
      <TD align="right">0.1</TD>
      <TD align="right">0.3</TD>
    </TR>
    <TR>
      <TD align="right">6</TD>
      <TD align="right">6.87</TD>
      <TD align="right">0.33</TD>
      <TD align="right">0.19</TD>
      <TD align="right">0.57</TD>
    </TR>
    <TR>
      <TD align="right">7</TD>
      <TD align="right">10.7</TD>
      <TD align="right">0.63</TD>
      <TD align="right">0.3</TD>
      <TD align="right">0.9</TD>
    </TR>
    <TR>
      <TD align="right">8</TD>
      <TD align="right">15.72</TD>
      <TD align="right">1.1</TD>
      <TD align="right">0.47</TD>
      <TD align="right">1.41</TD>
    </TR>
    <TR>
      <TD align="right">9</TD>
      <TD align="right">21.38</TD>
      <TD align="right">1.89</TD>
      <TD align="right">0.79</TD>
      <TD align="right">2.37</TD>
    </TR>
    <TR>
      <TD align="right">10</TD>
      <TD align="right">27.49</TD>
      <TD align="right">3.03</TD>
      <TD align="right">1.14</TD>
      <TD align="right">3.42</TD>
    </TR>
    <TR>
      <TD align="right">11</TD>
      <TD align="right">33.34</TD>
      <TD align="right">4.29</TD>
      <TD align="right">1.26</TD>
      <TD align="right">3.78</TD>
    </TR>
    <TR>
      <TD align="right">12</TD>
      <TD align="right">39.37</TD>
      <TD align="right">5.82</TD>
      <TD align="right">1.53</TD>
      <TD align="right">4.59</TD>
    </TR>
    <TR>
      <TD align="right">13</TD>
      <TD align="right">45.38</TD>
      <TD align="right">7.59</TD>
      <TD align="right">1.77</TD>
      <TD align="right">5.31</TD>
    </TR>
    <TR>
      <TD align="right">14</TD>
      <TD align="right">51.51</TD>
      <TD align="right">9.79</TD>
      <TD align="right">2.2</TD>
      <TD align="right">6.6</TD>
    </TR>
    <TR>
      <TD align="right">15</TD>
      <TD align="right">57.32</TD>
      <TD align="right">12.29</TD>
      <TD align="right">2.5</TD>
      <TD align="right">7.5</TD>
    </TR>
    <TR>
      <TD align="right">16</TD>
      <TD align="right">62.27</TD>
      <TD align="right">14.86</TD>
      <TD align="right">2.57</TD>
      <TD align="right">7.71</TD>
    </TR>
    <TR>
      <TD align="right">17</TD>
      <TD align="right">66.73</TD>
      <TD align="right">17.51</TD>
      <TD align="right">2.65</TD>
      <TD align="right">7.95</TD>
    </TR>
    <TR>
      <TD align="right">18</TD>
      <TD align="right">71.06</TD>
      <TD align="right">20.59</TD>
      <TD align="right">3.08</TD>
      <TD align="right">9.24</TD>
    </TR>
    <TR>
      <TD align="right">19</TD>
      <TD align="right">75.01</TD>
      <TD align="right">23.47</TD>
      <TD align="right">2.88</TD>
      <TD align="right">8.64</TD>
    </TR>
    <TR>
      <TD align="right">20</TD>
      <TD align="right">78.16</TD>
      <TD align="right">26.41</TD>
      <TD align="right">2.94</TD>
      <TD align="right">8.82</TD>
    </TR>
    <TR>
      <TD></TD>
      <TD></TD>
      <TD>累計</TD>
      <TD align="right">26.41</TD>
      <TD align="right">79.23</TD>
    </TR>
    <TR>
      <TD></TD>
      <TD></TD>
      <TD>ツモ和了率</TD>
      <TD align="right">25</TD>
    </TR>
    <TR>
      <TD></TD>
      <TD></TD>
      <TD>流局率概算値</TD>
      <TD align="right">0.001011851</TD>
    </TR>
  </TBODY>
</TABLE>
<P>ツモ和了率の実測は35％程度、流局率の実測は15％程度である。<BR>
そうなっていないのは「降りる人」を考慮していないからである。<BR>
そこで上記データにいくつかの補正を加えて、実測の値に近づくようにする。</P>
<TABLE border="1">
  <TBODY>
    <TR>
      <TD>ロン補正</TD>
      <TD align="right">2</TD>
      <TD>ツモ補正</TD>
      <TD align="right">0.5</TD>
    </TR>
    <TR>
      <TD>順</TD>
      <TD>ﾃﾝﾊﾟｲorﾂﾓ</TD>
      <TD>ツモ(累積)</TD>
      <TD>その順目でツモ</TD>
      <TD>その順目でのロン</TD>
    </TR>
    <TR>
      <TD align="right">1</TD>
      <TD align="right">0.07</TD>
      <TD align="right">0</TD>
      <TD align="right">0</TD>
      <TD align="right">0</TD>
    </TR>
    <TR>
      <TD align="right">2</TD>
      <TD align="right">0.22</TD>
      <TD align="right">0.01</TD>
      <TD align="right">0.005</TD>
      <TD align="right">0.01</TD>
    </TR>
    <TR>
      <TD align="right">3</TD>
      <TD align="right">0.66</TD>
      <TD align="right">0.01</TD>
      <TD align="right">0</TD>
      <TD align="right">0</TD>
    </TR>
    <TR>
      <TD align="right">4</TD>
      <TD align="right">1.88</TD>
      <TD align="right">0.04</TD>
      <TD align="right">0.015</TD>
      <TD align="right">0.03</TD>
    </TR>
    <TR>
      <TD align="right">5</TD>
      <TD align="right">3.81</TD>
      <TD align="right">0.14</TD>
      <TD align="right">0.05</TD>
      <TD align="right">0.1</TD>
    </TR>
    <TR>
      <TD align="right">6</TD>
      <TD align="right">6.87</TD>
      <TD align="right">0.33</TD>
      <TD align="right">0.095</TD>
      <TD align="right">0.19</TD>
    </TR>
    <TR>
      <TD align="right">7</TD>
      <TD align="right">10.7</TD>
      <TD align="right">0.63</TD>
      <TD align="right">0.15</TD>
      <TD align="right">0.3</TD>
    </TR>
    <TR>
      <TD align="right">8</TD>
      <TD align="right">15.72</TD>
      <TD align="right">1.1</TD>
      <TD align="right">0.235</TD>
      <TD align="right">0.47</TD>
    </TR>
    <TR>
      <TD align="right">9</TD>
      <TD align="right">21.38</TD>
      <TD align="right">1.89</TD>
      <TD align="right">0.395</TD>
      <TD align="right">0.79</TD>
    </TR>
    <TR>
      <TD align="right">10</TD>
      <TD align="right">27.49</TD>
      <TD align="right">3.03</TD>
      <TD align="right">0.57</TD>
      <TD align="right">1.14</TD>
    </TR>
    <TR>
      <TD align="right">11</TD>
      <TD align="right">33.34</TD>
      <TD align="right">4.29</TD>
      <TD align="right">0.63</TD>
      <TD align="right">1.26</TD>
    </TR>
    <TR>
      <TD align="right">12</TD>
      <TD align="right">39.37</TD>
      <TD align="right">5.82</TD>
      <TD align="right">0.765</TD>
      <TD align="right">1.53</TD>
    </TR>
    <TR>
      <TD align="right">13</TD>
      <TD align="right">45.38</TD>
      <TD align="right">7.59</TD>
      <TD align="right">0.885</TD>
      <TD align="right">1.77</TD>
    </TR>
    <TR>
      <TD align="right">14</TD>
      <TD align="right">51.51</TD>
      <TD align="right">9.79</TD>
      <TD align="right">1.1</TD>
      <TD align="right">2.2</TD>
    </TR>
    <TR>
      <TD align="right">15</TD>
      <TD align="right">57.32</TD>
      <TD align="right">12.29</TD>
      <TD align="right">1.25</TD>
      <TD align="right">2.5</TD>
    </TR>
    <TR>
      <TD align="right">16</TD>
      <TD align="right">62.27</TD>
      <TD align="right">14.86</TD>
      <TD align="right">1.285</TD>
      <TD align="right">2.57</TD>
    </TR>
    <TR>
      <TD align="right">17</TD>
      <TD align="right">66.73</TD>
      <TD align="right">17.51</TD>
      <TD align="right">1.325</TD>
      <TD align="right">2.65</TD>
    </TR>
    <TR>
      <TD align="right">18</TD>
      <TD align="right">71.06</TD>
      <TD align="right">20.59</TD>
      <TD align="right">1.54</TD>
      <TD align="right">3.08</TD>
    </TR>
    <TR>
      <TD align="right">19</TD>
      <TD align="right">75.01</TD>
      <TD align="right">23.47</TD>
      <TD align="right">1.44</TD>
      <TD align="right">2.88</TD>
    </TR>
    <TR>
      <TD align="right">20</TD>
      <TD align="right">78.16</TD>
      <TD align="right">26.41</TD>
      <TD align="right">1.47</TD>
      <TD align="right">2.94</TD>
    </TR>
    <TR>
      <TD></TD>
      <TD></TD>
      <TD>累計</TD>
      <TD align="right">13.205</TD>
      <TD align="right">26.41</TD>
    </TR>
    <TR>
      <TD></TD>
      <TD></TD>
      <TD>ツモ和了率</TD>
      <TD align="right">33.33333333</TD>
    </TR>
    <TR>
      <TD></TD>
      <TD></TD>
      <TD>流局率概算値</TD>
      <TD align="right">13.29585538</TD>
    </TR>
  </TBODY>
</TABLE>
<P>ロン補正とは、ロン率を求める際に、「ツモ率×3」のかわりに「ツモ率×ロン補正」によって置き換えるようなパラメータである。<BR>
これによってツモ和了率が33.3％となり、実測値35％に近い値となる。<BR>
ツモ補正とは、降りる可能性を考慮することによって、各順目のテンパイ確率（ツモ確率）を減らす係数で、「補正後のツモ確率＝補正前のツモ確率×ツモ補正」である。<BR>
これによって流局率の概算値は13.3％となり、実測値の15％に近い値となった。<BR>
<BR>
<BR>
以上をもとに、実際の初期値は以下のように設定した。<BR>
<BR>
for(int i=1;i&lt;=3;i++)<BR>
{<BR>
Tt[i][1]=0;<BR>
Tt[i][2]=0;<BR>
Tt[i][3]=0.01;<BR>
Tt[i][4]=0.03;<BR>
Tt[i][5]=0.1;<BR>
Tt[i][6]=0.19;<BR>
Tt[i][7]=0.3;<BR>
Tt[i][8]=0.47;<BR>
Tt[i][9]=0.79;<BR>
Tt[i][10]=1.14;<BR>
Tt[i][11]=1.26;<BR>
Tt[i][12]=1.53;<BR>
Tt[i][13]=1.77;<BR>
Tt[i][14]=2.2;<BR>
Tt[i][15]=2.5;<BR>
Tt[i][16]=2.57;<BR>
Tt[i][17]=2.65;<BR>
Tt[i][18]=3.08;<BR>
Tt[i][19]=2.88;<BR>
Tt[i][20]=2.94;<BR>
}<BR>
<BR>
for(int i=0;i&lt;=3;i++)<BR>
for(int j=1;j&lt;=20;j++)<BR>
{<BR>
Tt[i][j]/=100; //パーセント単位→確率単位の補正<BR>
Tt[i][j]*=0.5; //テンパイ確率の減衰（降りる人の影響）<BR>
Tr[i][j]=Tt[i][j]*2; //ロン確率<BR>
}<BR>
<BR>
この初期値のもと、Jr、JtをTr,Ttと同じ値にして「17順目まで誰も和了しない確率」を求めると15.6％、「18順目まで誰も和了しない確率」を求めると11.3％となり、およそ期待される結果となった。<BR>
<BR>
<BR>
<BR>
<B><FONT size="+1">他家や自分の挙動によるTt,Trの設定：</FONT></B><BR>
<BR>
当然、自分や他家が既にリーチしていたり、降りていたりすることが確定している場合は、パラメータを変更する必要がある。<BR>
<BR>
例えば自分がリーチしている場合は、Jtは順目によらず、簡単に言えば「1/34」とか「2/34」の一定値になる（もちろん待ちの枚数などを考慮すればよりよい）。<BR>
リーチ時には普通ツモ率が40〜50％となるので、他家3人のうち1.5人が降りる計算になるよう、Jrを適当に決めれば良い。<BR>
また、特定他家が降りることが明らかな場合や、既に降りている場合は、その他家の放銃確率だけを0に近い値に補正する。<BR>
他家のリーチについても同様に考えられる。<BR>
また、引っ掛けや字牌待ちの場合はJrが増加するので、実測によってそれらをうまく補正すると実用的になる。<BR>
他家が食い仕掛けをしている場合、テンパイが平均的に1順程度早くなるので（実測）、TrやTtの値は1順ずつ前に倒す。<BR>
同様に、2フーロ時ならばテンパイ確率は「リーチ」と同様にかなり高くなるので、適当に実測して設定する。<BR>
<BR>
<BR>
問題は、この方法がどの程度実情を捉えられるかということである。<BR>
計算方法そのものは理論的であって誤差が入り込むことはないが、パラメータの決定方法によって結果が非常に大きく影響を受けることは明らかである。<BR>
しかし、実際の麻雀では「こいつ・・・たぶんテンパイ」とか「おそらく降りてくるだろうから・・・」程度の曖昧な「読み」しかできないのが現状である。<BR>
それも、3フーロだから8割方テンパイ、とか、1フーロで中牌が出ていないからまだテンパイ率は1割くらいかというくらいにしか読めない。<BR>
その上その「読み」は、誤差の非常に大きな読みであるし、「テンパイ率10％の差」を打牌にどう生かすかというと、それを精確に行える人などいないと考えて良い。<BR>
実は「親リーチに対して自分がテンパイ、追っかけすべきかどうか」という単純な状況（それも、待ちの良さや点数分布が知られている場合）でさえも、直感的に正しい判断を下すことは難しいのが現状なのである。<BR>
同様に、「マンガンテンパイで2家リーチに危険な牌を切るべきか、どうか」「それが2家に対するアンパイであれば、どうか」という判断もである。<BR>
この理論はその程度に単純化された状況（パラメータの不確定要素が少ない状況）なら、間違うことなく判断を下すことができる。<BR>
<BR>
したがって実装する場合は、リャンメンリーチをかければ1順ごとの和了率は2/34、他家は1.5人降りる、2家リーチなら他家は1人降りる、というような程度のパラメータ分配で充分であると思われる。<BR>
この理論が判断すべき重要なことは、「リーチすべきかどうか」「〜〜順遅らせて待ちを変化させようとするとき、その前にツモってしまう確率はいくらか、待ちが変わった後の和了率はどうか、それに伴う順位上昇期待値はいくらか」というような判断の概算である。<BR>
麻雀は不確定要素が多いのだから、ある局面から「その局が流局するかどうか」などを10％誤差で当てることは非常に難しい。計算に拠ったところで、他家の手の内や行動まで全部把握することは不可能であるから、誤差が出てくること自体は避けられない。<BR>
しかし、確定要素が多い場合（例えば3人リーチや2人リーチの場合）などであれば、この理論はかなり上手に結果を予測することができるだろうし、そうでない場合においても印象と経験にしか基づかない判断よりは有益な判断を下すことができるだろう。<BR>
<BR>
<BR>
<BR>
<B><FONT size="+1">テンパイ時の打牌選択の方法論：</FONT></B><BR>
<BR>
以上の計算が、おおよそのパラメータを設定することでできるようになったことは理解されるだろう。<BR>
これをテンパイ時の打牌選択に導入するには、<BR>
「手変わりを待たずリーチする」→和了率や放銃率などを計算<BR>
「テンパイのまま手変わりを待つ」→手変わりまでに和了してしまう確率や、手変わりした場合の和了確率、各々の放銃確率を計算<BR>
「テンパイを崩して再テンパイを目指す」→可能なテンパイ形に対して、そうなるまでの平均順目を計算し、その上での和了率や放銃率の計算<BR>
のように計算し、各々対応する順位期待値上昇を比較すればよいことになる。<BR>
流局時テンパイ率の影響も計算できる。<BR>
<BR>
自分がテンパイの時は、平均値ではなくこのルーチンで全通り（1順後にツモ、2順後に形変化・・・の期待値）を計算すると良い。<BR>
自分がテンパイでない場合は、計算量の爆発を防ぐために、平均値を用いると良い。<BR>
<BR>
<BR>
ここでは、厳密に、テンパイ時の打牌選択の計算について考察しよう。ここでは、「実際にテンパイ」であるときにこの計算を使う状態と、「イーシャンテン以前の状態」からこの計算を呼び出す場合とで、挙動を変える工夫がなされている。それは、イーシャンテン以前からテンパイ形まで見越す場合は、その時点で場合わけが多数発生していて、この関数内で34通りなどの多数の場合わけをすることが好ましくないためである。<BR>
イーシャンテンルーチン、テンパイルーチンいずれにも言えることだが、再帰的に呼び出す場合は「制限」をもうけて、それまでの場合わけ数をあらかじめ常に把握しておき、場合わけ数が一定以上になった場合は適当な値を返すようにする工夫が必要である。<BR>
なおフリテンになる場合はロン和了を考慮しない。<BR><BR>
<B>・リーチする場合</B><BR>
リーチする場合の和了率や放銃率を計算することは容易だろう。ちなみに、「ツモ期待」してロンしない場合も計算するとより良い。<BR>
<BR>
<B>・テンパイを維持して手変わりを待つ場合</B><BR>
可能性として次の全てを考慮する。<BR>
・手変わりを待っている間にロン牌が出る場合の順位期待値<BR>
Jrを定めた上で、通常通り確率計算。<BR>
ただし、和了せずツモにかけたり流局にかけたり（ラス確を避けるためなど）することも考えられるので、ロンできる状況下で、「ツモるまで続ける場合の順位期待値」と「流局までツモらずにいる場合の順位期待値」とを各々計算し、その中で最善のものを選択する。<BR>
・手変わりを待っている間にツモ牌をツモる場合の順位期待値<BR>
Jtを定めて計算。〜〜順でツモる確率を求める。現在テンパイならその各々について以下を計算、現在テンパイ以前なら平均値を用いて以下を計算。<BR>
ツモる場合は、順位期待値を通常通り計算。<BR>
和了牌を引いたのにツモらない場合は、その順目以降での「手変わりを待つ場合」を再帰的に呼び出すことで同等の計算ができる。<BR>
これらの選択のうち最も順位期待値が高くなるものを選択したとして、それを「手変わりを待っている場合にツモる場合の順位期待値」と考える。<BR>
・手変わりを待っている間にロン・ツモせず、かつ手変わりする場合の順位期待値<BR>
テンパイ維持をしたまま手変わりする可能性は以下のように概算する。<BR>
「現在」テンパイの場合、全ての牌を加えてみて、そこから取り出される「良い待ち」に手変わりしたものと考える。そうなる確率は、その牌を引く確率である。<BR>
その確率に応じた順目後にあらためて「テンパイした」と考えて、再帰的にこの関数を呼び出す。<BR>
「現在」イーシャンテン以前の場合で、この関数がイーシャンテンの形評価の一部として呼び出されている時は、計算量の爆発を抑えるため、非常に単純な簡単化を行う。つまり例えば、リャンメンへの変化の可能性は、現在の待ちが頭待ちであれば「メンツの端にひっつく確率」であるし、現在の待ちがシャンポンであれば「シャンポンの2種類にリャンメン待ちとしてひっつく確率」「22345から136が来る確率」などである（もちろんフリテンの場合は除く）。ターツ部分とメンツ部分の位置関係のいくつかに対して概算できるようにしておく（几帳面に全パターンを網羅する必要はない）。そしてその場合ごとに、その順目でリャンメンテンパイしたものとみなし、かつリーチするかその後の手変わりを考えないでダマにするものと決めてしまって、この関数を再帰的に呼び出す。<BR>
イーシャンテンの段階テンパイ形の変化について「概算」しかできないのは不安かもしれないが、そもそもテンパイの状態で手変わりを待つことを真剣に考えるべきイーシャンテンというのはあまり状況が多くなく、しかもそれによって劇的に評価が変化する場合は極めてまれである。とつげき東北などは、そこまで考えずに打っているから、最強の自動打ちアルゴリズムとしては問題なかろう。<BR>
<BR>
<B>・イーシャンテンに戻す場合</B><BR>
テンパイなのにイーシャンテンに戻す、という状況はどうか。<BR>
イーシャンテン時の判定ルーチンがテンパイ時判定ルーチンを呼び出すことはほとんど明らかなので、テンパイ時ルーチンが再帰的にイーシャンテンルーチンを無制限に呼び出すことは得策ではない。<BR>
テンパイからイーシャンテンに戻すときは、その後のテンパイ形への変化をこのルーチン内部で考慮して計算してしまう。<BR>
イーシャンテンの段階である程度和了の期待値を見込んでおけば、実際にテンパイの段階でイーシャンテンに戻すことについてあまり深刻になる必要はない。<BR>
「リャンメン化」程度を考慮すれば充分であり、テンパイ維持で手変わりを待つ場合と同様の計算をすればよいことになる。<BR>
<BR><BR><BR><BR>
・手変わりの概算<BR>
取り出しえる全ての「浮き牌」について、28なら3または7をつもでリャンメン化、3〜7なら2種類でリャンメン化と考える。<BR>
1234の形なら35が、3456の形なら浮き牌が36だから2457が変化形と考えられる（フリテン除外）。<BR>
現在35　　7　という形であれば、3を切れば5と7で3種類、などのように計算できる。<BR>
リャンメン化ではなく35からの33東東待ちへの変化などを考慮する場合も同様。<BR>
「浮き牌」に対してそれに関連する牌をツモる確率はわかるので、その場合の和了点数を計算してやればよい。<BR>
また浮き牌自体が変化する場合もあり（1→5など）、現在の浮き牌の関係ない牌をつもることによって待ちがよりよくなることも考慮する。<BR>
137から待ちを良くすることを考えて7を切るのは明らかにﾏﾁｶﾞｲだが、それを計算させられるよう工夫する。<BR>
<BR>
※<BR>
Pelse=1;<BR>
//自分の1打が他家にロンされる確率（ここだけは、その牌に応じて簡単にでも補正するべき）<BR>
take1ronbyjibun=Tr[1,r];<BR>
Pelse=Pelse*(1-take1ronbyjibun=Tr[1,r]);<BR>
take2ronbyjibun=Tr[2,r];<BR>
Pelse=Pelse*(1-take1ronbyjibun=Tr[2,r]);<BR>
take3ronbyjibun=Tr[3,r];<BR>
・・・<BR>
のような形でテンパイ用のルーチンを考えたが、浮き牌からテンパイへ移行する場合のルーチンも考えるか？<BR>
つまりイーシャンテン専用のもの。（というか浮き牌→テンパイという流れはJtとしてひっつきを考えればできるか・・・？）<BR>
イーシャンテンから浮き牌をころころ変えていくことを全てシミュレートするのは困難。<BR>
簡単に「1ならよりよくなる確率は〜〜、2なら・・・」という感じで近似したほうがいい<BR>
<BR>
<BR>
<BR>
<BR>
リャンシャンテンへ戻す場合は別の計算がいるかもしれない。<BR>
つまりイーシャンテンの形にさらに「引いてきた1枚」を別に考えるくらいの思考水準がほしい。<BR>
13　　6789　135567　西西<BR>
だと13あたりを切る。<BR>
リャンシャンテンとは「メンツ2つ頭1つ」「メンツ3つ」のいずれかの状態であって、それらを除くようなあらゆる牌の組み合わせに対して、<BR>
メンツ化の効率を計算すべき。<BR>
上の例だと　13　6　　135　または　13　9　135　が「浮き牌」として残るわけだが、<BR>
ここからメンツを1つ作るための確率と組み合わせを考え、それが完成した場合のテンパイ時判断を計算する。<BR>
例えば6を切ると13135が残るが、この場合のテンパイ判断はあまり良い値にならないだろう。<BR>
1を切ると36135が残り、テンパイ判断はよりよくなるかもしれない。<BR>
テンパイ判断がもっともよくなる確率の高い場合の打牌を選択する。<BR>
<BR><BR><BR>
<BR>
<B><FONT size="+1">イーシャンテン時の打牌選択の方法論：</FONT></B><BR><BR>
・テンパイを取る場合<BR>
そのテンパイ形に対して、テンパイ時判断を呼び出す。<BR><BR>
・テンパイを取らない場合<BR>
次にツモる全ての牌の組み合わせに対して、テンパイする場合にはテンパイ時判断を呼び出す。<BR>
<BR>
・リャンシャンテンに戻す場合<BR>
ツモるあらゆる3牌の組み合わせ（34*34*34=39304）に対して、テンパイする場合にそうなる平均順目を求め、各々テンパイ時判断を呼び出す。チーポンを含んで良い場合も考慮する。<BR><BR>
<BR><BR><BR><BR><BR>
<BR><BR><BR>
<BR>
<BR>
<B><FONT size="+1">よりよい補正のために必要な実測：</FONT></B><BR>
<BR>
・フーロ時の順目別テンパイ率の実測<BR>
・染め手時の順目別、捨て牌別のテンパイ率の実測（「染め手」をどう判断するかの理論も必要なので発展課題）<BR>
<BR>
<BR>
<BR>
<BR>
<BR>
<BR>
<BR>
<BR>
</P>
</BODY>
</HTML>
